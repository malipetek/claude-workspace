#!/bin/bash

#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  CLAUDE WORKSPACE
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
#  DESCRIPTION:
#    Workspace manager for Claude Code with Ghostty split-pane integration.
#    Quickly switch between projects and launch Claude with dev processes.
#
#  USAGE:
#    claude-workspace                    # Interactive project selector
#    claude-workspace <project_name>     # Open specific project
#    claude-workspace setup              # Run setup wizard
#    claude-workspace add <path>         # Add project to registry
#    claude-workspace --simple <name>    # Launch Claude only (no workspace)
#
#  WORKSPACE INTEGRATION:
#    If a project has .claude-workspace.json, it will automatically:
#    - Open Ghostty with split panes
#    - Run Claude on the left
#    - Run dev processes on the right
#
#â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCRIPT_DIR="$HOME/.claude-workspace/scripts"
REGISTRY="$HOME/.claude-workspace/registry.json"
VERSION="1.3.0"

show_help() {
    cat << 'EOF'
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  CLAUDE WORKSPACE                                                            â•‘
â•‘  Workspace manager for Claude Code with AI delegation                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USAGE:
  claude-workspace                      Interactive project selector
  claude-workspace <project_name>       Open specific project
  claude-workspace setup                Run setup wizard
  claude-workspace settings             Configure AI tools & delegation
  claude-workspace add <path>           Add project to registry
  claude-workspace list                 List registered projects
  claude-workspace update               Update to latest version
  claude-workspace --simple <project>   Launch Claude only (no workspace)
  claude-workspace --help               Show this help

WORKSPACE MODE:
  If the project has .claude-workspace.json, it opens Ghostty with split panes:

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                 â”‚   Dev Process 1 â”‚
  â”‚     Claude      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚      Code       â”‚   Dev Process 2 â”‚
  â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                 â”‚   Dev Process 3 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CONFIG FILE (.claude-workspace.json):
  Create this file in your project root to define dev processes:

  {
    "processes": [
      {
        "name": "frontend",
        "command": "pnpm dev",
        "cwd": "./frontend"
      },
      {
        "name": "backend",
        "command": "pnpm start:dev",
        "cwd": "./backend"
      },
      {
        "name": "database",
        "command": "docker compose up db",
        "cwd": "."
      },
      {
        "name": "storybook",
        "command": "pnpm storybook",
        "cwd": "./frontend"
      }
    ]
  }

  Process options:
    name      Display name for the process (shown in terminal title)
    command   Shell command to run (supports any shell command)
    cwd       Working directory relative to project root ("." for root)

AI DELEGATION:
  Claude can delegate tasks to other AI tools (Gemini, OpenCode, etc.)

  Configure with: claude-workspace settings

  Delegation modes:
    --visible    Watch AI work in a split terminal pane
    --branch     Isolate work on a feature branch (prevents conflicts)

  Delegation levels (0-4):
    0: Disabled   - Claude handles everything
    1: Minimal    - Only research/summarization
    2: Moderate   - Routine tasks (tests, types, docs)
    3: Aggressive - Most implementation, Claude reviews
    4: Orchestrator - Claude only orchestrates

KEYBOARD SHORTCUTS (Interactive Mode):
  â†‘/â†“               Navigate projects
  Enter             Launch project
  w                 Force workspace mode
  s                 Force simple mode (Claude only)
  q                 Quit

MORE INFO:
  https://github.com/malipetek/claude-workspace

EOF
}

# Function to launch a project
launch_project() {
    local project_path="$1"
    local force_mode="$2"  # "workspace", "simple", or ""
    local project_name=$(basename "$project_path")

    local workspace_config="$project_path/.claude-workspace.json"
    local has_workspace=false

    if [ -f "$workspace_config" ]; then
        has_workspace=true
    fi

    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  Launching: $project_name"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Path: $project_path"

    # Determine launch mode
    local use_workspace=false

    if [ "$force_mode" = "workspace" ]; then
        if [ "$has_workspace" = true ]; then
            use_workspace=true
        else
            echo "Warning: No .claude-workspace.json found, launching Claude only"
        fi
    elif [ "$force_mode" = "simple" ]; then
        use_workspace=false
    elif [ "$has_workspace" = true ]; then
        use_workspace=true
    fi

    if [ "$use_workspace" = true ]; then
        echo "Mode: Workspace (Ghostty split panes)"
        echo ""

        # Show processes that will be started
        local process_count=$(jq '.processes | length' "$workspace_config")
        echo "Dev processes ($process_count):"
        for i in $(seq 0 $(($process_count - 1))); do
            local name=$(jq -r ".processes[$i].name" "$workspace_config")
            local cmd=$(jq -r ".processes[$i].command" "$workspace_config")
            echo "  [$((i+1))] $name: $cmd"
        done
        echo ""

        # Launch workspace
        exec "$SCRIPT_DIR/workspace.sh" "$project_path"
    else
        echo "Mode: Simple (Claude only)"
        echo ""

        if [ "$has_workspace" = true ]; then
            echo "Tip: This project has .claude-workspace.json"
            echo "     Run 'claude-workspace $project_name' to use workspace mode"
            echo ""
        fi

        cd "$project_path" || exit 1
        exec claude
    fi
}

# Function to add a project
add_project() {
    local project_path="$1"

    # Resolve to absolute path
    project_path="$(cd "$project_path" 2>/dev/null && pwd)" || {
        echo "Error: Directory not found: $1"
        exit 1
    }

    local project_name=$(basename "$project_path")

    echo ""
    read -p "Project name [$project_name]: " custom_name
    project_name=${custom_name:-$project_name}

    read -p "Description (optional): " description

    # Add to registry
    local temp=$(mktemp)
    jq ".projects[\"$project_name\"] = {\"path\": \"$project_path\", \"description\": \"$description\", \"status\": \"active\"}" "$REGISTRY" > "$temp"
    mv "$temp" "$REGISTRY"

    echo ""
    echo "âœ“ Added '$project_name' to registry"
    echo ""

    if [ ! -f "$project_path/.claude-workspace.json" ]; then
        read -p "Create .claude-workspace.json? [Y/n] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            exec "$SCRIPT_DIR/setup.sh" "$project_path"
        fi
    fi
}

# Function to list projects
list_projects() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  Registered Projects                                                         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""

    jq -r '.projects | to_entries[] | "\(.key)\t\(.value.path)\t\(.value.description // "")"' "$REGISTRY" 2>/dev/null | while IFS=$'\t' read -r name path desc; do
        local workspace_indicator=""
        [ -f "$path/.claude-workspace.json" ] && workspace_indicator=" [workspace]"

        echo "  $name$workspace_indicator"
        echo "    Path: $path"
        [ -n "$desc" ] && echo "    Description: $desc"
        echo ""
    done
}

# Check for help flag first
if [ "$1" = "-h" ] || [ "$1" = "--help" ] || [ "$1" = "help" ]; then
    show_help
    exit 0
fi

if [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    echo "claude-workspace version $VERSION"
    exit 0
fi

# Handle subcommands
case "$1" in
    setup)
        exec "$SCRIPT_DIR/setup.sh"
        ;;
    add)
        if [ -z "$2" ]; then
            echo "Usage: claude-workspace add <path>"
            exit 1
        fi
        add_project "$2"
        exit 0
        ;;
    list)
        list_projects
        exit 0
        ;;
    settings)
        exec "$SCRIPT_DIR/settings.sh" "${@:2}"
        ;;
    update)
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  Updating Claude Workspace...                                                â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        # Check for git repo
        if [ -d "$HOME/.claude-workspace/.git" ]; then
            echo "Updating via git..."
            cd "$HOME/.claude-workspace"
            git fetch origin
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse origin/main)
            if [ "$LOCAL" = "$REMOTE" ]; then
                echo "âœ“ Already up to date (v$VERSION)"
            else
                git pull origin main
                echo ""
                echo "âœ“ Updated successfully!"
                NEW_VERSION=$(grep "^VERSION=" "$SCRIPT_DIR/ai-project" | cut -d'"' -f2)
                echo "  New version: $NEW_VERSION"
            fi
        else
            echo "Updating via install script..."
            curl -fsSL https://raw.githubusercontent.com/malipetek/claude-workspace/main/install.sh | bash
        fi
        echo ""
        exit 0
        ;;
esac

# Check for simple mode flag
FORCE_MODE=""
if [ "$1" = "--simple" ] || [ "$1" = "-s" ]; then
    FORCE_MODE="simple"
    shift
fi

if [ "$1" = "--workspace" ] || [ "$1" = "-w" ]; then
    FORCE_MODE="workspace"
    shift
fi

# Ensure directories exist
mkdir -p "$HOME/.claude-workspace"/{scripts,logs,dev-logs,status,dev-markers}

if [ ! -f "$REGISTRY" ]; then
    echo '{"projects":{}}' > "$REGISTRY"
fi

# Check if jq is available
if ! command -v jq &> /dev/null; then
    echo "Error: jq is required"
    echo "Install with: brew install jq"
    exit 1
fi

# Get all project names
PROJECT_NAMES=($(jq -r '.projects | keys[]' "$REGISTRY" 2>/dev/null))

# If project name provided as argument
if [ -n "$1" ]; then
    PROJECT_NAME="$1"

    # Check if project exists
    PROJECT_PATH=$(jq -r ".projects[\"$PROJECT_NAME\"].path // empty" "$REGISTRY")

    if [ -z "$PROJECT_PATH" ]; then
        echo "Error: Project '$PROJECT_NAME' not found in registry"
        echo ""
        echo "Available projects:"
        for name in "${PROJECT_NAMES[@]}"; do
            echo "  - $name"
        done
        echo ""
        echo "Run 'claude-workspace add /path/to/project' to add a new project."
        exit 1
    fi

    # Check if directory exists
    if [ ! -d "$PROJECT_PATH" ]; then
        echo "Error: Project directory not found: $PROJECT_PATH"
        exit 1
    fi

    launch_project "$PROJECT_PATH" "$FORCE_MODE"
    exit 0
fi

# Build unified menu items
# Format: "type:name:extra_info"
MENU_ITEMS=()
MENU_TYPES=()

# Add projects first
for name in "${PROJECT_NAMES[@]}"; do
    MENU_ITEMS+=("$name")
    MENU_TYPES+=("project")
done

# Add separator if we have projects
if [ ${#PROJECT_NAMES[@]} -gt 0 ]; then
    MENU_ITEMS+=("---")
    MENU_TYPES+=("separator")
fi

# Add commands
MENU_ITEMS+=("Setup Wizard")
MENU_TYPES+=("setup")

MENU_ITEMS+=("Settings")
MENU_TYPES+=("settings")

MENU_ITEMS+=("Add Project")
MENU_TYPES+=("add")

MENU_ITEMS+=("List Projects")
MENU_TYPES+=("list")

MENU_ITEMS+=("Update")
MENU_TYPES+=("update")

MENU_ITEMS+=("Help")
MENU_TYPES+=("help")

# Interactive mode - arrow key selection
selected=0
total=${#MENU_ITEMS[@]}

# Skip separator if it's selected
skip_separator() {
    while [ "${MENU_TYPES[$selected]}" = "separator" ]; do
        if [ "$1" = "down" ]; then
            ((selected++))
            [ $selected -ge $total ] && selected=0
        else
            ((selected--))
            [ $selected -lt 0 ] && selected=$((total - 1))
        fi
    done
}

# Hide cursor
tput civis

# Cleanup on exit
cleanup() {
    tput cnorm  # Show cursor
    tput sgr0   # Reset colors
}
trap cleanup EXIT

# Function to draw the menu
draw_menu() {
    clear
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘  CLAUDE WORKSPACE                                                v$VERSION â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "  â†‘/â†“: Navigate   Enter: Select   w: Workspace mode   s: Simple mode   q: Quit"
    echo ""

    local in_projects=true
    local showed_projects_header=false

    for i in "${!MENU_ITEMS[@]}"; do
        # Show PROJECTS header before first project
        if [ "$in_projects" = true ] && [ "${MENU_TYPES[$i]}" = "project" ] && [ "$showed_projects_header" = false ]; then
            tput setaf 8
            echo "  PROJECTS"
            tput sgr0
            echo ""
            showed_projects_header=true
        fi
        local item="${MENU_ITEMS[$i]}"
        local type="${MENU_TYPES[$i]}"

        # Handle separator
        if [ "$type" = "separator" ]; then
            echo ""
            tput setaf 8
            echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "  COMMANDS"
            tput sgr0
            echo ""
            in_projects=false
            continue
        fi

        # Handle projects
        if [ "$type" = "project" ]; then
            local path=$(jq -r ".projects[\"$item\"].path" "$REGISTRY")
            local desc=$(jq -r ".projects[\"$item\"].description // \"\"" "$REGISTRY")

            local workspace_indicator=""
            local process_count=0
            if [ -f "$path/.claude-workspace.json" ]; then
                process_count=$(jq '.processes | length' "$path/.claude-workspace.json" 2>/dev/null || echo 0)
                workspace_indicator=" [âŠ $process_count]"
            fi

            if [ $i -eq $selected ]; then
                tput setaf 0
                tput setab 2
                echo " â–¶ $item$workspace_indicator"
                tput sgr0
                tput setaf 8
                echo "   $path"
                [ -n "$desc" ] && echo "   $desc"
                tput sgr0
            else
                if [ -n "$workspace_indicator" ]; then
                    tput setaf 6
                    echo "   $item$workspace_indicator"
                    tput sgr0
                else
                    echo "   $item"
                fi
            fi

        # Handle commands
        else
            local icon=""
            local description=""
            case "$type" in
                setup)    icon="âš™ï¸ "; description="Configure projects and workspaces" ;;
                settings) icon="ğŸ›ï¸ "; description="AI tools and delegation settings" ;;
                add)      icon="â•"; description="Add a new project to registry" ;;
                list)     icon="ğŸ“‹"; description="Show all registered projects" ;;
                update)   icon="ğŸ”„"; description="Update to latest version" ;;
                help)     icon="â“"; description="Show help and documentation" ;;
            esac

            if [ $i -eq $selected ]; then
                tput setaf 0
                tput setab 2
                echo " â–¶ $icon $item"
                tput sgr0
                tput setaf 8
                echo "   $description"
                tput sgr0
            else
                echo "   $icon $item"
            fi
        fi
    done

    # Show project count
    echo ""
    tput setaf 8
    echo "  ${#PROJECT_NAMES[@]} project(s) registered"
    tput sgr0
}

# Initial draw
skip_separator "down"
draw_menu

# Read input
while true; do
    read -rsn1 key

    case "$key" in
        q|Q)
            echo ""
            exit 0
            ;;
        w|W)  # Force workspace mode (only for projects)
            if [ "${MENU_TYPES[$selected]}" = "project" ]; then
                FORCE_MODE="workspace"
                break
            fi
            ;;
        s|S)  # Force simple mode (only for projects)
            if [ "${MENU_TYPES[$selected]}" = "project" ]; then
                FORCE_MODE="simple"
                break
            fi
            ;;
        "")  # Enter key
            break
            ;;
        $'\x1b')  # Escape sequence (arrow keys)
            read -rsn2 -t 1 key
            case "$key" in
                '[A')  # Up arrow
                    ((selected--))
                    [ $selected -lt 0 ] && selected=$((total - 1))
                    skip_separator "up"
                    ;;
                '[B')  # Down arrow
                    ((selected++))
                    [ $selected -ge $total ] && selected=0
                    skip_separator "down"
                    ;;
            esac
            draw_menu
            ;;
    esac
done

# Handle selection based on type
SELECTED_TYPE="${MENU_TYPES[$selected]}"
SELECTED_ITEM="${MENU_ITEMS[$selected]}"

case "$SELECTED_TYPE" in
    project)
        PROJECT_PATH=$(jq -r ".projects[\"$SELECTED_ITEM\"].path" "$REGISTRY")

        if [ ! -d "$PROJECT_PATH" ]; then
            echo "Error: Project directory not found: $PROJECT_PATH"
            exit 1
        fi

        launch_project "$PROJECT_PATH" "$FORCE_MODE"
        ;;
    setup)
        exec "$SCRIPT_DIR/setup.sh"
        ;;
    settings)
        exec "$SCRIPT_DIR/settings.sh"
        ;;
    add)
        echo ""
        read -p "Project path: " project_path
        project_path="${project_path/#\~/$HOME}"
        if [ -d "$project_path" ]; then
            add_project "$project_path"
        else
            echo "Error: Directory not found"
            exit 1
        fi
        ;;
    list)
        list_projects
        ;;
    update)
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  Updating Claude Workspace...                                                â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        if [ -d "$HOME/.claude-workspace/.git" ]; then
            echo "Updating via git..."
            cd "$HOME/.claude-workspace"
            git fetch origin
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse origin/main)
            if [ "$LOCAL" = "$REMOTE" ]; then
                echo "âœ“ Already up to date (v$VERSION)"
            else
                git pull origin main
                echo ""
                echo "âœ“ Updated successfully!"
                NEW_VERSION=$(grep "^VERSION=" "$SCRIPT_DIR/ai-project" | cut -d'"' -f2)
                echo "  New version: $NEW_VERSION"
            fi
        else
            echo "Updating via install script..."
            curl -fsSL https://raw.githubusercontent.com/malipetek/claude-workspace/main/install.sh | bash
        fi
        ;;
    help)
        show_help
        ;;
esac
